---
title: "Untitled"
output: html_document
date: "2025-05-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Comparing the predicted targets with significant genes in the TWAS paper

```{r message=FALSE, warning=FALSE}
twas_path <- "data/twas/"

all_unique  <- list()
all_analyses <- list()

# List all subdirectories inside the main directory
subdirs <- list.dirs(twas_path, recursive = FALSE)

# Loop through each subdirectory
for (subdir in subdirs) {

  analyses_genes <- list()
  unique_genes <- c()
  
  # Find the CSV file in the subdirectory
  csv_files <- list.files(subdir, pattern = "\\.csv$", full.names = TRUE)
  
  # If there's at least one CSV file, read it
  if (length(csv_files) > 0) {
    csv_path <- csv_files[1]  # Assuming there's only one CSV per folder
    
    # Extract the file name without extension
    file_name <- tools::file_path_sans_ext(basename(csv_path))
    
    data <- read.csv(csv_path, header = TRUE)
    
    for (col in colnames(data)){
      genes <- unique(data[[col]])
      analyses_genes[[col]] <- genes
      unique_genes <- unique(c(unique_genes, genes))
    }
    
    all_analyses[[file_name]] <- analyses_genes
    all_unique[[file_name]] <- unique_genes
    
  } else {
    warning(paste("No CSV file found in", subdir))
  }
}

all_genes <- unname(unlist(all_unique))
```

```{r message=FALSE, warning=FALSE}
load(file='data/target_prediction/targets_intersection.RData')

sea_targets <- read.csv("data/target_prediction/sea/sea_targets.csv")$x
stp_targets <- read.csv("data/target_prediction/stpnovo/stp_targets.csv")$x
all_targets <- union(sea_targets, stp_targets)

all_analyses_intersect <- list()
all_analyses_intersect_alltargets <- list()

all_unique_genes_intersect <- list()
all_unique_genes_intersect_alltargets <- list()

for (file_name in names(all_analyses)){
  analyses_intersect <- list()
  analyses_intersect_alltargets <- list()

  analyses_genes <- all_analyses[[file_name]]
  
  for (analysis in names(analyses_genes)){
    analysis_genes <- unname(unlist(analyses_genes[[analysis]]))
    analyses_intersect[[paste0(file_name, '_', analysis)]] <- intersect(analysis_genes, targets_intersection)
    analyses_intersect_alltargets[[paste0(file_name, '_', analysis)]] <- intersect(analysis_genes, all_targets)
  }
  all_analyses_intersect[[file_name]] <- analyses_intersect
  all_analyses_intersect_alltargets[[file_name]] <- analyses_intersect_alltargets

  unique_genes <- unname(unlist(all_unique[[file_name]]))
  all_unique_genes_intersect[[file_name]] <- intersect(unique_genes, targets_intersection)
  all_unique_genes_intersect_alltargets[[file_name]] <- intersect(unique_genes, all_targets)
}

twas_targets <-  unique(unlist(all_analyses_intersect, use.names = FALSE))

pairwise_intersections <- combn(all_unique_genes_intersect, 2, function(x) intersect(x[[1]], x[[2]]), simplify = FALSE)
pairwise_genes <- unique(unlist(pairwise_intersections, use.names = FALSE))

threewise_intersections <- combn(all_unique_genes_intersect, 3, function(x) Reduce(intersect, x), simplify = FALSE)
threewise_genes <- unique(unlist(threewise_intersections, use.names = FALSE))

save(all_analyses_intersect, all_unique_genes_intersect, file = "data/twas/intersections.RData")
```


# Comparing with previous analyses

```{r}
type_intersection <- unique(unlist(unname(type_intersection)))
type_intersection_alltargets <- unique(unlist(unname(type_intersection_alltargets)))

all_results <- list(notype_intersection, type_intersection, variance_intersection, twas_targets)
all_results_alltargets <- list(notype_intersection_alltargets, type_intersection_alltargets, variance_intersection_alltargets, twas_targets_alltargets)

# Define names for the analyses
analysis_names <- c("no_type", "type", "variance", "twas")
names(all_results) <- analysis_names

# Create a named list of all genes with their corresponding analysis
gene_to_analyses <- list()

for (i in seq_along(all_results)) {
  genes <- all_results[[i]]
  analysis <- analysis_names[i]
  
  for (gene in genes) {
    gene_to_analyses[[gene]] <- unique(c(gene_to_analyses[[gene]], analysis))
  }
}

gene_analyses_df <- tibble::tibble(
  gene = names(gene_to_analyses),
  analyses = sapply(gene_to_analyses, function(x) paste(sort(x), collapse = ","))
)

multi_analysis_genes <- gene_analyses_df %>% 
  filter(lengths(gene_to_analyses) > 1)
```

```{r}
analysis_names_alltargets <- c("no_type", "type", "variance", "twas")
names(all_results_alltargets) <- analysis_names_alltargets

# Criar mapeamento gene → análises (para _alltargets)
gene_to_analyses_alltargets <- list()

for (i in seq_along(all_results_alltargets)) {
  genes <- all_results_alltargets[[i]]
  analysis <- analysis_names_alltargets[i]
  
  for (gene in genes) {
    gene_to_analyses_alltargets[[gene]] <- unique(c(gene_to_analyses_alltargets[[gene]], analysis))
  }
}

# Converter para data frame
library(dplyr)

gene_analyses_df_alltargets <- tibble::tibble(
  gene = names(gene_to_analyses_alltargets),
  analyses = sapply(gene_to_analyses_alltargets, function(x) paste(sort(x), collapse = ","))
)

multi_analysis_genes_alltargets <- gene_analyses_df_alltargets %>% 
  filter(lengths(gene_to_analyses_alltargets) > 1)

save(gene_analyses_df, gene_analyses_df_alltargets, file = "data/all_analyses_comparison.RData")
```

# Getting the predicted metabolites/ligands for the intersection genes

```{r}
library(readxl)
get_targets_to_metabolites <- function(folder_path) {
  # Listar todos os arquivos CSV
  csv_files <- list.files(path = folder_path, 
                          pattern = "^(cid|nocid).*\\.csv$", 
                          full.names = TRUE)
  
  # Lista final
  targets_to_metabolites <- list()
  
  for (file_path in csv_files) {
    file_name <- basename(file_path)
    
    # Extrair ID do metabólito (cidXXX ou nome completo se for nocid)
    if (grepl("^cid", file_name)) {
      metabolite_id <- sub("cid(.*)\\.csv", "\\1", file_name)
    } else if (grepl("^nocid", file_name)) {
      metabolite_id <- sub("\\.csv$", "", file_name)
    }
    
    # Ignorar arquivos vazios
    if (file.info(file_path)$size == 0) next
    
    # Ler dados
    data <- read.csv(file_path, stringsAsFactors = FALSE)
    
    if (nrow(data) == 0 || !"Common.name" %in% names(data)) next
    
    for (target in data[["Common.name"]]) {
      if (!is.character(target) || is.na(target) || target == "") next
      
      if (is.null(targets_to_metabolites[[target]])) {
        targets_to_metabolites[[target]] <- c()
      }
      
      targets_to_metabolites[[target]] <- c(targets_to_metabolites[[target]], metabolite_id)
    }
  }
  
  return(targets_to_metabolites)
}

target_metabolites_stp <- get_targets_to_metabolites("data/target_prediction/stpnovo")
save(target_metabolites_stp, file="data/target_prediction/stpnovo/target_metabolites_stp.RData")
```