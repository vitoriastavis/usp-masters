---
title: "Untitled"
output: html_document
date: "2025-05-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Comparing the predicted targets with significant genes in the TWAS paper

```{r message=FALSE, warning=FALSE}
twas_path <- "data/twas/"

all_unique  <- list()
all_analyses <- list()

# List all subdirectories inside the main directory
subdirs <- list.dirs(twas_path, recursive = FALSE)

# Loop through each subdirectory
for (subdir in subdirs) {

  analyses_genes <- list()
  unique_genes <- c()
  
  # Find the CSV file in the subdirectory
  csv_files <- list.files(subdir, pattern = "\\.csv$", full.names = TRUE)
  
  # If there's at least one CSV file, read it
  if (length(csv_files) > 0) {
    csv_path <- csv_files[1]  # Assuming there's only one CSV per folder
    
    # Extract the file name without extension
    file_name <- tools::file_path_sans_ext(basename(csv_path))
    
    data <- read.csv(csv_path, header = TRUE)
    
    for (col in colnames(data)){
      genes <- unique(data[[col]])
      analyses_genes[[col]] <- genes
      unique_genes <- unique(c(unique_genes, genes))
    }
    
    all_analyses[[file_name]] <- analyses_genes
    all_unique[[file_name]] <- unique_genes
    
  } else {
    warning(paste("No CSV file found in", subdir))
  }
}

all_twas <- unname(unlist(all_unique))
```


```{r}
# Lista para guardar os resultados
intersection_results <- list()

# Ler cada arquivo CSV e fazer interseção com snrnaseq_intersection
csv_folder <- "./data/target_prediction/intersections"
csv_files <- list.files(csv_folder, pattern = "\\.csv$", full.names = TRUE)

for (file in csv_files) {
  # Read raw lines first
  raw_lines <- readLines(file, warn = FALSE)

  # Nome base do arquivo para usar como key
  key <- gsub("^intersection_|\\.csv$", "", basename(file))
  
  # Ler CSV
  # print(file)
  df <- read.csv(file, stringsAsFactors = FALSE)
  # print(file)
  # Garantir vetor
  vec <- as.character(df$target)
  
  intersection_results[[key]] <- intersect(vec, all_twas)
  
  # Interseção com snrnaseq_intersection
  # for (twas in names(all_unique)){
  #   genes_twas <- all_unique[[twas]]
  #   key <- paste0(basename(file), twas)
  #   inter <- intersect(vec, genes_twas)
  #   intersection_results[[key]] <- inter
  # }
}

all_intersects <- unique(unname(unlist(intersection_results)))
```


```{r}
library(dplyr)

# all_unique: lista nomeada; cada elemento = vetor de genes de um autor
# nomes da lista = Adams2025, etc.

gene_author <- bind_rows(
  lapply(names(all_unique), function(auth) {
    data.frame(
      gene   = all_unique[[auth]],
      author = auth,
      stringsAsFactors = FALSE
    )
  })
)

# remover NAs ou strings vazias se existirem
gene_author <- gene_author %>%
  filter(!is.na(gene), gene != "")

genes_autores <- gene_author %>%
  group_by(gene) %>%
  summarise(
    n_autores = n_distinct(author),
    autores   = paste(sort(unique(author)), collapse = ", ")
  ) 

genes_autores_alvos <- genes_autores %>%
  filter(gene %in% all_intersects) %>%
  arrange(desc(n_autores), gene)

genes_autores_alvos_filtrado <- genes_autores_alvos %>%
  filter(n_autores > 1)
```

# Comparing with previous analyses

```{r}

load("./sct/degs_sct_celltype/results_sct_celltype.RData")
load("./sct/degs_sct_novo/results_sct.RData")
load("./rnaseq/deg_outputs/results_214951.RData")
load("./data/snrnaseq/results_logn.RData")
load("./data/snrnaseq/results_logn_celltype.RData")

all_sct_celltype <- unique(unlist(unname(results_sct_celltype)))
all_sct <- unique(unlist(unname(results_sct)))
all_214951 <- unique(unlist(unname(results_214951)))
all_logn <- unique(unlist(unname(results_logn)))
all_logn_celltype <- unique(unlist(unname(results_logn_celltype)))

all_results <- list(all_sct, all_sct_celltype, all_logn, all_logn_celltype, all_214951, all_twas)

# Define names for the analyses
analysis_names <- c("SCT", "SCT-celltype", "logn", "logn-celltype", "214951", "TWAS")
names(all_results) <- analysis_names

# Create a named list of all genes with their corresponding analysis
gene_to_analyses <- list()

for (i in seq_along(all_results)) {
  genes <- all_results[[i]]
  analysis <- analysis_names[i]
  
  for (gene in genes) {
    gene_to_analyses[[gene]] <- unique(c(gene_to_analyses[[gene]], analysis))
  }
}

gene_analyses_df <- tibble::tibble(
  gene = names(gene_to_analyses),
  analyses = sapply(gene_to_analyses, function(x) paste(sort(x), collapse = ","))
)

multi_analysis_genes <- gene_analyses_df %>% 
  filter(lengths(gene_to_analyses) > 1)
```

# Getting the predicted metabolites/ligands for the intersection genes

```{r}
gene <- "RARB"

cat(gene)
gene %in% rownames(GSE144136_celltype_filtered$InN) & gene %in% rownames(GSE213982_celltype_filtered$InN)
gene %in% rownames(GSE144136_celltype_filtered$ExN) & gene %in% rownames(GSE213982_celltype_filtered$ExN)
gene %in% rownames(GSE144136_celltype_filtered$Oli) & gene %in% rownames(GSE213982_celltype_filtered$Oli)
gene %in% rownames(GSE144136_celltype_filtered$Ast) & gene %in% rownames(GSE213982_celltype_filtered$Ast)
gene %in% rownames(GSE144136_celltype_filtered$Miv) & gene %in% rownames(GSE213982_celltype_filtered$Mic)
gene %in% rownames(GSE144136_celltype_filtered$Mic) & gene %in% rownames(GSE213982_celltype_filtered$Mic)
gene %in% rownames(GSE144136_celltype_filtered$OPC) & gene %in% rownames(GSE213982_celltype_filtered$OPC)
gene %in% rownames(GSE144136_celltype_filtered$End) & gene %in% rownames(GSE213982_celltype_filtered$End)

```