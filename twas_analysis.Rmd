---
title: "Untitled"
output: html_document
date: "2025-05-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Comparing the predicted targets with significant genes in the TWAS paper

```{r message=FALSE, warning=FALSE}
twas_path <- "data/twas/"

all_unique  <- list()
all_analyses <- list()

# List all subdirectories inside the main directory
subdirs <- list.dirs(twas_path, recursive = FALSE)

# Loop through each subdirectory
for (subdir in subdirs) {

  analyses_genes <- list()
  unique_genes <- c()
  
  # Find the CSV file in the subdirectory
  csv_files <- list.files(subdir, pattern = "\\.csv$", full.names = TRUE)
  
  # If there's at least one CSV file, read it
  if (length(csv_files) > 0) {
    csv_path <- csv_files[1]  # Assuming there's only one CSV per folder
    
    # Extract the file name without extension
    file_name <- tools::file_path_sans_ext(basename(csv_path))
    
    data <- read.csv(csv_path, header = TRUE)
    
    for (col in colnames(data)){
      genes <- unique(data[[col]])
      analyses_genes[[col]] <- genes
      unique_genes <- unique(c(unique_genes, genes))
    }
    
    all_analyses[[file_name]] <- analyses_genes
    all_unique[[file_name]] <- unique_genes
    
  } else {
    warning(paste("No CSV file found in", subdir))
  }
}

all_genes <- unname(unlist(all_unique))
```

```{r message=FALSE, warning=FALSE}
load(file='data/target_prediction/targets_intersection.RData')

sea_targets <- read.csv("data/target_prediction/sea/sea_targets.csv")$x
stp_targets <- read.csv("data/target_prediction/stpnovo/stp_targets.csv")$x
all_targets <- union(sea_targets, stp_targets)

all_analyses_intersect <- list()
all_analyses_intersect_alltargets <- list()

all_unique_genes_intersect <- list()
all_unique_genes_intersect_alltargets <- list()

for (file_name in names(all_analyses)){
  analyses_intersect <- list()
  analyses_intersect_alltargets <- list()

  analyses_genes <- all_analyses[[file_name]]
  
  for (analysis in names(analyses_genes)){
    analysis_genes <- unname(unlist(analyses_genes[[analysis]]))
    analyses_intersect[[paste0(file_name, '_', analysis)]] <- intersect(analysis_genes, targets_intersection)
    analyses_intersect_alltargets[[paste0(file_name, '_', analysis)]] <- intersect(analysis_genes, all_targets)
  }
  all_analyses_intersect[[file_name]] <- analyses_intersect
  all_analyses_intersect_alltargets[[file_name]] <- analyses_intersect_alltargets

  unique_genes <- unname(unlist(all_unique[[file_name]]))
  all_unique_genes_intersect[[file_name]] <- intersect(unique_genes, targets_intersection)
  all_unique_genes_intersect_alltargets[[file_name]] <- intersect(unique_genes, all_targets)
}

twas_targets <-  unique(unlist(all_analyses_intersect, use.names = FALSE))
twas_targets_alltargets <-  unique(unlist(all_analyses_intersect_alltargets, use.names = FALSE))

N = 22500 # Human genes
K = length(targets_intersection) # Intersection of SEA and STP predicted targets
n = length(all_genes) # All genes found in TWAS
k = length(twas_targets) # Intersection of TWAS and predicted targets
overlap_hypergeometric <- phyper(k-1, K, N - K, n, lower.tail = FALSE)

pairwise_intersections <- combn(all_unique_genes_intersect, 2, function(x) intersect(x[[1]], x[[2]]), simplify = FALSE)
pairwise_genes <- unique(unlist(pairwise_intersections, use.names = FALSE))

threewise_intersections <- combn(all_unique_genes_intersect, 3, function(x) Reduce(intersect, x), simplify = FALSE)
threewise_genes <- unique(unlist(threewise_intersections, use.names = FALSE))

save(all_analyses_intersect, all_unique_genes_intersect, file = "data/twas/intersections.RData")
```


# Comparing with previous analyses

```{r}
type_intersection <- unique(unlist(unname(type_intersection)))
type_intersection_alltargets <- unique(unlist(unname(type_intersection_alltargets)))

all_results <- list(notype_intersection, type_intersection, variance_intersection, twas_targets)
all_results_alltargets <- list(notype_intersection_alltargets, type_intersection_alltargets, variance_intersection_alltargets, twas_targets_alltargets)

# Define names for the analyses
analysis_names <- c("no_type", "type", "variance", "twas")
names(all_results) <- analysis_names

# Create a named list of all genes with their corresponding analysis
gene_to_analyses <- list()

for (i in seq_along(all_results)) {
  genes <- all_results[[i]]
  analysis <- analysis_names[i]
  
  for (gene in genes) {
    gene_to_analyses[[gene]] <- unique(c(gene_to_analyses[[gene]], analysis))
  }
}

gene_analyses_df <- tibble::tibble(
  gene = names(gene_to_analyses),
  analyses = sapply(gene_to_analyses, function(x) paste(sort(x), collapse = ","))
)

multi_analysis_genes <- gene_analyses_df %>% 
  filter(lengths(gene_to_analyses) > 1)
```

```{r}
analysis_names_alltargets <- c("no_type", "type", "variance", "twas")
names(all_results_alltargets) <- analysis_names_alltargets

# Criar mapeamento gene → análises (para _alltargets)
gene_to_analyses_alltargets <- list()

for (i in seq_along(all_results_alltargets)) {
  genes <- all_results_alltargets[[i]]
  analysis <- analysis_names_alltargets[i]
  
  for (gene in genes) {
    gene_to_analyses_alltargets[[gene]] <- unique(c(gene_to_analyses_alltargets[[gene]], analysis))
  }
}

# Converter para data frame
library(dplyr)

gene_analyses_df_alltargets <- tibble::tibble(
  gene = names(gene_to_analyses_alltargets),
  analyses = sapply(gene_to_analyses_alltargets, function(x) paste(sort(x), collapse = ","))
)

multi_analysis_genes_alltargets <- gene_analyses_df_alltargets %>% 
  filter(lengths(gene_to_analyses_alltargets) > 1)

save(gene_analyses_df, gene_analyses_df_alltargets, file = "data/all_analyses_comparison.RData")
```

# Getting the predicted metabolites/ligands for the intersection genes

```{r}
sea_result <- read_xlsx("data/target_prediction/sea/sea-combined.xlsx")
sea_mappings <- read.csv("data/target_prediction/sea/sea_mappings.csv")
# Rename columns to avoid special character issues
colnames(sea_result) <- c("Query_ID", "Target_ID", "Affinity_Threshold", "P_Value",
                          "Max_Tc", "Cut_Sum", "Z_Score", "Name", "Description", "Query_Smiles")

# Get only the human targets 
sea_result <- sea_result[grepl("_HUMAN$", sea_result$Target_ID), ]

# Lista onde cada elemento é um vetor de alvos por metabólito
targets_metabolites <- list()

for (target in twas_targets) {
  all_metabolites <- c()
  metabolites_rows <- sea_result[sea_result$Name == target, ]
  metabolites <- unique(metabolites_rows$Query_ID)
  metabolites <- gsub("cid", "", metabolites)
  all_metabolites <- c(all_metabolites, metabolites)
  
  original_queries <- sea_mappings[!is.na(sea_mappings$HGNC_ID) & sea_mappings$HGNC_ID == target, ]
  for (query in original_queries$Query){
    metabolites_rows <- sea_result[sea_result$Name == query, ]
    metabolites <- unique(metabolites_rows$Query_ID)
    metabolites <- gsub("^cid", "", metabolites)
    
    all_metabolites <- c(all_metabolites, metabolites)
  }

  
  # Armazena no resultado
  targets_metabolites[[target]] <- unique(all_metabolites)
}

all_twas_metabolites <- unique(unlist(targets_metabolites))
```