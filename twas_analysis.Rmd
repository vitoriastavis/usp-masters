---
title: "Untitled"
output: html_document
date: "2025-05-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Comparing the predicted targets with significant genes in the TWAS paper

```{r message=FALSE, warning=FALSE}
twas_path <- "data/twas/"

all_unique_genes  <- list()
all_analyses <- list()

# List all subdirectories inside the main directory
subdirs <- list.dirs(twas_path, recursive = FALSE)

# Loop through each subdirectory
for (subdir in subdirs) {

  analyses_genes <- list()
  unique_genes <- c()
  
  # Find the CSV file in the subdirectory
  csv_files <- list.files(subdir, pattern = "\\.csv$", full.names = TRUE)
  
  # If there's at least one CSV file, read it
  if (length(csv_files) > 0) {
    csv_path <- csv_files[1]  # Assuming there's only one CSV per folder
    
    # Extract the file name without extension
    file_name <- tools::file_path_sans_ext(basename(csv_path))
    
    data <- read.csv(csv_path, header = TRUE)
    
    for (col in colnames(data)){
      genes <- unique(data[[col]])
      analyses_genes[[col]] <- genes
      unique_genes <- unique(c(unique_genes, genes))
    }
    
    all_analyses[[file_name]] <- analyses_genes
    all_unique_genes[[file_name]] <- unique_genes
    
  } else {
    warning(paste("No CSV file found in", subdir))
  }
}
```

```{r message=FALSE, warning=FALSE}

sea_targets <- read.csv("data/target_prediction/sea/sea_targets.csv")$x
stp_targets <- read.csv("data/target_prediction/stpnovo/stp_targets.csv")$x
all_targets <- unique(c(sea_targets, stp_targets))

all_analyses_intersect <- list()
all_unique_genes_intersect <- list()

for (file_name in names(all_analyses)){
  print(file_name)
  analyses_intersect <- list()
  unique_intersect <- list()
  
  analyses_genes <- all_analyses[[file_name]]
  
  for (analysis in names(analyses_genes)){
    analysis_genes <- unname(unlist(analyses_genes[[analysis]]))
    analyses_intersect[[paste0(file_name, '_', analysis)]] <- intersect(analysis_genes, targets_intersection)
  }
  all_analyses_intersect[[file_name]] <- analyses_intersect
  
  
  unique_genes <- unname(unlist(all_unique_genes[[file_name]]))
  all_unique_genes_intersect[[file_name]] <- intersect(unique_genes, all_targets)
}

pairwise_intersections <- combn(all_unique_genes_intersect, 2, function(x) intersect(x[[1]], x[[2]]), simplify = FALSE)
pairwise_genes <- unique(unlist(pairwise_intersections, use.names = FALSE))

threewise_intersections <- combn(all_unique_genes_intersect, 3, function(x) Reduce(intersect, x), simplify = FALSE)
threewise_genes <- unique(unlist(threewise_intersections, use.names = FALSE))

save(all_analyses_intersect, all_unique_genes_intersect, file = "data/twas/intersections.RData")
```

# Getting the predicted metabolites/ligands for the intersection genes

```{r}
sea_result <- read.csv("data/target_prediction/sea/sea_results.xls")

# Rename columns to avoid special character issues
colnames(sea_result) <- c("Query_ID", "Target_ID", "Affinity_Threshold", "P_Value",
                          "Max_Tc", "Cut_Sum", "Z_Score", "Name", "Description", "Query_Smiles")

# Get only the human targets 
sea_result <- sea_result[grepl("_HUMAN$", sea_result$Target_ID), ]

EPHB2 <- sea_result[sea_result$Name == "EPHB2", ]
metabolites_EPHB2 <- EPHB2$Query_ID

TNKS2 <- sea_result[sea_result$Name == "TNKS2", ]
metabolites_TNKS2 <- TNKS2$Query_ID
```
