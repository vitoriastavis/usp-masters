---
title: "Untitled"
output: html_document
---

## Conections between targets and metabolites

```{R}
load("targets_metabolites.RData")
library(dplyr)

targets_to_metabolites$S1PR1 <- unique(targets_to_metabolites$S1PR1)
targets_to_metabolites$EDNRB <- unique(targets_to_metabolites$EDNRB)

targets_to_metabolites$NR4A1 <- NULL
targets_to_metabolites$TRIL <- NULL
targets_to_metabolites$FOS <- NULL
targets_to_metabolites$F3 <- NULL

edges_target_met <- data.frame(
                            Source = rep(names(targets_to_metabolites), lengths(targets_to_metabolites)),
                            Target = unlist(targets_to_metabolites))

# Save information about gene and metabolite nodes
nodes <- data.frame(
  name = unique(c(edges_target_met$Source, edges_target_met$Target)),
  type = c(rep("Gene", length(unique(edges_target_met$Source))), rep("Metabolite", length(unique(edges_target_met$Target))))
)

relevant_metabolites <- unique(edges_target_met$Target)
```

## Conections between species and metabolites

```{R}
library(stringr)
load("~/Documents/vitoria/usp-masters/data/gutmgene/gutmgene1_beforemerging.RData")

gutmgene_species <- gutmgene1 %>%
                        mutate(Microbe_Species = word(Gut_Microbe_Name, 1))

edges_species_met <- data.frame(
                            Source = gutmgene_species$Microbe_Species,
                            Target = gutmgene_species$Metabolite_Name)

# Remove bacteria that do not produce the relevant metabolites 
edges_species_met <- edges_species_met[edges_species_met$Target %in% relevant_metabolites, ]

# Get bacteria that produce the metabolites
relevant_species <- unique(edges_species_met$Source)
```

## Connections between species and MDD

```{R}
# install.packages("jsonlite")
library(jsonlite)
library(stringr)
library(dplyr)

disbiome.JSON <- fromJSON("data/network/species_mdd.json")
disbiome_df <- as.data.frame(disbiome.JSON)
disbiome_df <- disbiome_df %>%
                        mutate(species = word(organism_name, 1))

edges_species_mdd <- data.frame(
                            Source = unique(disbiome_df$species),
                            Target = rep("MDD", length(unique(disbiome_df$species))))

edges_species_mdd <- edges_species_mdd[edges_species_mdd$Source %in% relevant_species, ]

# Remove bacteria that are not associated with MDD
edges_species_met <- edges_species_met[edges_species_met$Source %in% unique(edges_species_mdd$Source), ]

# Save information about species and MDD nodes
nodes <- rbind(nodes, data.frame(
                          name = edges_species_mdd$Source,
                          type = rep("Species", length(unique(edges_species_mdd$Source)))
              ))
nodes <- rbind(nodes, data.frame(
                            name = "MDD",
                            type = "Disorder"
                        ))
```

## Conections between MDD and KEGG, and MDD and Reactome

```{R}
library(stringr)

mdd_kegg_react <- read.table("data/network/mdd_kegg_react.csv", sep = ",", header = TRUE)
mdd_kegg <- mdd_kegg_react[str_detect(mdd_kegg_react$Pathway.ID, "KEGG"),]
mdd_react <- mdd_kegg_react[str_detect(mdd_kegg_react$Pathway.ID, "REACT"),]

edges_mdd_kegg <- data.frame(
                        Source = rep("MDD", nrow(mdd_kegg)),
                        Target = mdd_kegg$Pathway)
edges_mdd_react <- data.frame(
                        Source = rep("MDD", nrow(mdd_react)),
                        Target = mdd_react$Pathway)
edges_mdd_pathways <- rbind(edges_mdd_kegg, edges_mdd_react)

relevant_pathways <- unique(edges_mdd_pathways$Target)
```

## Conections between genes and KEGG

```{R}
s1pr1_kegg <- read.table("data/network/s1pr1_ednrb/s1pr1_kegg.txt", sep = "\t", header = F)
ednrb_kegg <- read.table("data/network/s1pr1_ednrb/ednrb_kegg.txt", sep = "\t", header = F)
genes_kegg <- rbind(s1pr1_kegg, ednrb_kegg)

edges_target_kegg <- data.frame(
                            Source = c(rep("S1PR1", nrow(s1pr1_kegg)), rep("EDNRB", nrow(ednrb_kegg))),
                            Target = c(s1pr1_kegg$V2, ednrb_kegg$V2))

edges_target_kegg <- edges_target_kegg[edges_target_kegg$Target %in% relevant_pathways, ]

# Save information about KEGG pathway nodes
nodes <- rbind(nodes, data.frame(
                        name = unique(edges_target_kegg$Target),
                        type = rep("Pathway", length(unique(edges_target_kegg$Target)))
              ))
```

## Conections between genes and Reactome

```{R}
s1pr1_react <- read.csv("data/network/s1pr1_ednrb/s1pr1_react.csv", sep = ",", header = TRUE)
ednrb_react <- read.csv("data/network/s1pr1_ednrb/ednrb_react.csv", sep = ",", header = TRUE)

edges_target_react <- data.frame(
                            Source = c(rep("S1PR1", nrow(s1pr1_react)), rep("EDNRB", nrow(ednrb_react))),
                            Target = c(s1pr1_react$Pathway.name, ednrb_react$Pathway.name))

edges_target_react <- edges_target_react[edges_target_react$Target %in% relevant_pathways, ]

# Save information about reactome pathway nodes
nodes <- rbind(nodes, data.frame(
                        name = unique(edges_target_react$Target),
                        type = rep("Pathway", length(unique(edges_target_react$Target)))
              ))
```

```{R}
# Save information about MDD pathway nodes
edges_mdd_pathways = edges_mdd_pathways[edges_mdd_pathways$Target %in% c(edges_target_react$Target, edges_target_kegg$Target), ]
nodes <- rbind(nodes, data.frame(
                        name = unique(edges_mdd_pathways$Target),
                        type = rep("Pathway", length(unique(edges_mdd_pathways$Target)))
              ))
```


## Get all the edges and node type, clean and save

```{R}
edges <- rbind(edges_target_met, edges_target_react, edges_target_kegg, edges_mdd_pathways, edges_species_mdd, edges_species_met)
edges_clean <- distinct(edges)

nodes_clean <- distinct(nodes)
order <- c("Species", "Pathway", "Metabolite", "Gene", "Disorder")
nodes_clean <- nodes_clean %>%
  mutate(layer = as.numeric(factor(type, levels = order)))

# Save
write.table(edges_clean, file = "data/network/s1pr1_ednrb/cytoscape_edges.tsv", row.names=FALSE, sep="\t")
write.table(nodes_clean, file = "data/network/s1pr1_ednrb/cytoscape_nodes.tsv", row.names=FALSE, sep="\t")
```

<!-- ```{R} -->
<!-- library(jsonlite) -->
<!-- library(dplyr) -->

<!-- nodes_list <- nodes_clean %>% -->
<!--   mutate(id = name) %>%          -->
<!--   rowwise() %>% -->
<!--   mutate(data = list(list( -->
<!--     id = id, -->
<!--     type = type, -->
<!--     layer = layer -->
<!--   ))) %>% -->
<!--   pull(data)                      -->

<!-- # 2. Criar lista de arestas no formato Cytoscape.js -->
<!-- edges_list <- edges_clean %>% -->
<!--   rowwise() %>% -->
<!--   mutate(data = list(list( -->
<!--     source = Source, -->
<!--     target = Target -->
<!--   ))) %>% -->
<!--   pull(data) -->

<!-- # 3. Combinar em um objeto "elements" -->
<!-- cyjs_list <- list(elements = list( -->
<!--   nodes = nodes_list, -->
<!--   edges = edges_list -->
<!-- )) -->

<!-- # 4. Salvar como JSON -->
<!-- write_json(cyjs_list, "data/network/s1pr1_ednrb/network_elements.cyjs", pretty = TRUE, auto_unbox = TRUE) -->
<!-- ``` -->
